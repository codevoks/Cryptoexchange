# -----------------------
# Builder stage
# -----------------------
FROM node:20-alpine AS builder

WORKDIR /app

# Copy root files first
COPY package.json package-lock.json turbo.json .npmrc ./

# Copy web app package.json so npm workspace resolves deps
COPY apps/web/package.json apps/web/

# Copy packages folder (including prisma)
COPY packages packages/

# Prisma CLI expects schema in default location, so copy it
RUN mkdir -p prisma
COPY packages/db/prisma/schema.prisma prisma/schema.prisma

# Install dependencies
RUN npm install --workspaces --legacy-peer-deps --ignore-scripts

# Copy everything else (source files)
COPY . .

# Generate Prisma client using the copied schema
RUN npx prisma generate --schema=prisma/schema.prisma

# Build web app
RUN npx turbo run build --filter=web

# -----------------------
# Production stage
# -----------------------
FROM node:20-alpine

WORKDIR /app
ENV NODE_ENV=production

# Copy .next output, public, package.json, node_modules, packages
COPY --from=builder /app/apps/web/.next ./.next
COPY --from=builder /app/apps/web/public ./public
COPY --from=builder /app/apps/web/package.json ./package.json
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/packages ./packages

# Copy Prisma schema + migrations
RUN mkdir -p prisma/migrations
COPY --from=builder /app/packages/db/prisma/schema.prisma prisma/schema.prisma
COPY --from=builder /app/packages/db/prisma/migrations prisma/migrations

# Expose port
EXPOSE 3000

# Run migrations + start app
CMD ["sh", "-c", "npx prisma migrate deploy --schema=prisma/schema.prisma && npm start"]